<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>米團購訂單表單</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // 使用 Inter 字體
                    },
                }
            }
        }
    </script>
    <!-- 引入 Supabase JavaScript 客戶端函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 font-sans">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">米團購訂單表單</h1>

        <!-- 姓名輸入區塊 -->
        <div class="mb-5">
            <label for="customerName" class="block text-gray-700 text-sm font-medium mb-2">您的姓名:</label>
            <input type="text" id="customerName" placeholder="請輸入您的姓名" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out shadow-sm">
        </div>

        <!-- 手機號碼輸入區塊 -->
        <div class="mb-5">
            <label for="phoneNumber" class="block text-gray-700 text-sm font-medium mb-2">手機號碼:</label>
            <input type="tel" id="phoneNumber" placeholder="請輸入您的手機號碼" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out shadow-sm">
        </div>

        <!-- 地址輸入區塊 -->
        <div class="mb-5">
            <label for="address" class="block text-gray-700 text-sm font-medium mb-2">地址:</label>
            <input type="text" id="address" placeholder="請輸入您的地址" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out shadow-sm">
        </div>

        <!-- 動態米品選擇區塊 -->
        <div id="riceItemsContainer" class="mb-6 border p-4 rounded-lg bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">訂購米品:</h2>
            <!-- 第一個米品項目 (預設) -->
            <div class="rice-item-row flex flex-col sm:flex-row sm:items-end gap-3 mb-4 p-3 border border-gray-200 rounded-lg bg-white shadow-sm">
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-medium mb-1">米種:</label>
                    <select class="rice-type-select w-full px-3 py-1.5 border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400 text-sm">
                        <option value="糙米">糙米</option>
                        <option value="白米">白米</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-medium mb-1">數量 (公斤):</label>
                    <select class="quantity-select w-full px-3 py-1.5 border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400 text-sm">
                        <!-- 數量選項將由 JavaScript 生成 -->
                    </select>
                </div>
                <button type="button" class="remove-item-btn mt-2 sm:mt-0 px-3 py-1.5 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 text-sm">移除</button>
            </div>
        </div>

        <!-- 新增米品按鈕 -->
        <button type="button" id="addRiceItemBtn"
                class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 transition duration-200 ease-in-out text-base font-semibold mb-6">
            新增米品
        </button>

        <!-- 運費顯示區塊 -->
        <div id="shippingCostDisplay" class="text-lg font-semibold text-gray-700 text-center mb-4 p-2 bg-gray-50 rounded-lg border border-gray-200">
            運費: $0.00
        </div>

        <!-- 總金額顯示區塊 -->
        <div id="totalPrice" class="text-3xl font-extrabold text-blue-700 text-center mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            總金額: $0.00
        </div>

        <!-- 提交訂單按鈕 -->
        <button id="submitOrderBtn"
                class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out transform active:scale-95 text-lg font-semibold shadow-md">
            提交訂單
        </button>

        <!-- 訊息顯示區塊 -->
        <div id="messageDisplay" class="mt-5 p-3 rounded-lg text-center font-medium hidden whitespace-pre-wrap"></div>
    </div>

    <script>
        // --- Supabase 配置 ---
        // 請將這裡替換為你的 Supabase URL 和 Anon Key
        const SUPABASE_URL = "YOUR_SUPABASE_URL"; // 替換為你的 Supabase URL
        const SUPABASE_KEY = "YOUR_SUPABASE_KEY"; // 替換為你的 Supabase Anon Key
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 商品資訊 ---
        const PRICE_PER_KG = 150;
        const SHIPPING_COST_BASE = 150; // 基本運費
        const BOX_QUANTITY = 20; // 箱裝公斤數
        const BOX_PRICE = PRICE_PER_KG * BOX_QUANTITY; // 箱裝價格

        // --- DOM 元素獲取 ---
        const customerNameInput = document.getElementById('customerName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const addressInput = document.getElementById('address');
        const riceItemsContainer = document.getElementById('riceItemsContainer');
        const addRiceItemBtn = document.getElementById('addRiceItemBtn');
        const shippingCostDisplay = document.getElementById('shippingCostDisplay');
        const totalPriceDisplay = document.getElementById('totalPrice');
        const submitOrderBtn = document.getElementById('submitOrderBtn');
        const messageDisplay = document.getElementById('messageDisplay');

        // --- 函式：生成數量選項 (1-19公斤, 20公斤箱裝) ---
        function generateQuantityOptions() {
            let optionsHtml = '';
            for (let i = 1; i <= 19; i++) {
                optionsHtml += `<option value="${i}">${i} 公斤</option>`;
            }
            optionsHtml += `<option value="${BOX_QUANTITY}">20 公斤 (箱裝)</option>`;
            return optionsHtml;
        }

        // --- 函式：新增一個米品項目列 ---
        function addRiceItemRow() {
            const newRow = document.createElement('div');
            newRow.className = 'rice-item-row flex flex-col sm:flex-row sm:items-end gap-3 mb-4 p-3 border border-gray-200 rounded-lg bg-white shadow-sm';
            newRow.innerHTML = `
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-medium mb-1">米種:</label>
                    <select class="rice-type-select w-full px-3 py-1.5 border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400 text-sm">
                        <option value="糙米">糙米</option>
                        <option value="白米">白米</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-medium mb-1">數量 (公斤):</label>
                    <select class="quantity-select w-full px-3 py-1.5 border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400 text-sm">
                        ${generateQuantityOptions()}
                    </select>
                </div>
                <button type="button" class="remove-item-btn mt-2 sm:mt-0 px-3 py-1.5 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 text-sm">移除</button>
            `;
            riceItemsContainer.appendChild(newRow);

            // 為新加入的元素綁定事件監聽器
            newRow.querySelector('.quantity-select').addEventListener('change', calculateTotalPrice);
            newRow.querySelector('.rice-type-select').addEventListener('change', calculateTotalPrice);
            newRow.querySelector('.remove-item-btn').addEventListener('click', (e) => {
                // 至少保留一個項目
                if (riceItemsContainer.querySelectorAll('.rice-item-row').length > 1) {
                    newRow.remove();
                    calculateTotalPrice(); // 移除後重新計算總價
                } else {
                    showMessage("至少需要保留一個訂購項目。", "error");
                }
            });
            calculateTotalPrice(); // 新增項目後重新計算總價
        }

        // --- 函式：計算總金額和運費 ---
        function calculateTotalPrice() {
            let subtotal = 0;
            let hasBoxQuantity = false;
            const orderedItems = []; // 用於儲存訂購的詳細項目

            document.querySelectorAll('.rice-item-row').forEach(row => {
                const riceType = row.querySelector('.rice-type-select').value;
                const quantity = parseInt(row.querySelector('.quantity-select').value);

                if (quantity === BOX_QUANTITY) {
                    subtotal += BOX_PRICE;
                    hasBoxQuantity = true;
                } else {
                    subtotal += quantity * PRICE_PER_KG;
                }
                orderedItems.push({ rice_type: riceType, quantity: quantity });
            });

            let currentShippingCost = SHIPPING_COST_BASE;
            if (hasBoxQuantity) {
                currentShippingCost = 0; // 訂購箱裝米則免運
            }

            const finalTotalPrice = subtotal + currentShippingCost;

            shippingCostDisplay.textContent = `運費: $${currentShippingCost.toFixed(2)}`;
            totalPriceDisplay.textContent = `總金額: $${finalTotalPrice.toFixed(2)}`;
            return { finalTotalPrice, currentShippingCost, orderedItems };
        }

        // --- 函式：顯示訊息 (成功/錯誤) ---
        function showMessage(msg, type) {
            messageDisplay.textContent = msg;
            messageDisplay.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (type === 'success') {
                messageDisplay.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageDisplay.classList.add('bg-red-100', 'text-red-800');
            }
            messageDisplay.style.display = 'block'; // 確保顯示
            // 訊息不再自動隱藏，讓LLM生成的內容可以被完整閱讀
            // setTimeout(() => {
            //     messageDisplay.classList.add('hidden');
            // }, 5000);
        }

        // --- 函式：呼叫 Gemini API 生成訂單摘要 ---
        async function generateOrderSummaryWithLLM(customerName, orderedItems, shippingCost, totalPrice) {
            messageDisplay.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            messageDisplay.classList.add('bg-gray-100', 'text-gray-700'); // 顯示為載入中狀態
            messageDisplay.textContent = '✨ 正在生成個性化訂單確認訊息...';
            messageDisplay.style.display = 'block';

            const itemDetailsString = orderedItems.map(item => `${item.rice_type}: ${item.quantity} 公斤`).join(', ');

            const prompt = `請為以下米團購訂單生成一個友善且個性化的訂單確認訊息。內容應包含客戶姓名、訂購明細、運費和總金額。請使用溫暖的語氣，並提及感謝訂購。不要包含任何 Markdown 格式（例如粗體、列表符號），只提供純文字。

訂單詳情：
姓名: ${customerName}
訂購明細: ${itemDetailsString}
運費: $${shippingCost.toFixed(2)}
總金額: $${totalPrice.toFixed(2)}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas 將自動提供 API 金鑰
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    showMessage(`✨ ${text}`, "success"); // 將 LLM 生成的內容顯示為成功訊息
                } else {
                    console.error('Gemini API 返回了意外的結構或沒有內容:', result);
                    showMessage("訂單提交成功，但無法生成個性化確認訊息。請稍後再試。", "error");
                }
            } catch (error) {
                console.error('呼叫 Gemini API 失敗:', error);
                showMessage("訂單提交成功，但生成個性化確認訊息時發生錯誤。請檢查網路連接。", "error");
            }
        }

        // --- 函式：提交訂單到 Supabase ---
        async function submitOrder() {
            const customerName = customerNameInput.value.trim();
            const phoneNumber = phoneNumberInput.value.trim();
            const address = addressInput.value.trim();

            if (!customerName) {
                showMessage("請輸入您的姓名。", "error");
                return;
            }
            if (!phoneNumber) {
                showMessage("請輸入您的手機號碼。", "error");
                return;
            }
            if (!address) {
                showMessage("請輸入您的地址。", "error");
                return;
            }

            const { finalTotalPrice, currentShippingCost, orderedItems } = calculateTotalPrice();

            // 檢查是否有訂購任何米品
            if (orderedItems.length === 0) {
                showMessage("請至少訂購一個米品。", "error");
                return;
            }

            try {
                // 禁用按鈕防止重複提交
                submitOrderBtn.disabled = true;
                submitOrderBtn.textContent = '提交中...';
                submitOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');

                const { data, error } = await supabase
                    .from('orders') // 你的 Supabase 表格名稱
                    .insert([
                        {
                            customer_name: customerName,
                            phone_number: phoneNumber,
                            address: address,
                            items_details: orderedItems, // 儲存訂購的詳細項目 (JSONB)
                            shipping_cost: currentShippingCost, // 儲存運費
                            total_price: finalTotalPrice // 總價包含運費
                        }
                    ]);

                if (error) {
                    console.error('提交訂單錯誤:', error);
                    showMessage(`訂單提交失敗: ${error.message}`, "error");
                } else {
                    // 訂單提交成功後，呼叫 LLM 生成個性化訊息
                    await generateOrderSummaryWithLLM(customerName, orderedItems, currentShippingCost, finalTotalPrice);

                    // 清空表單並重設為預設狀態
                    customerNameInput.value = '';
                    phoneNumberInput.value = '';
                    addressInput.value = '';
                    // 移除所有動態新增的項目，只保留一個預設項目
                    document.querySelectorAll('.rice-item-row:not(:first-child)').forEach(row => row.remove());
                    // 重設第一個項目的選擇
                    const firstRiceTypeSelect = document.querySelector('.rice-item-row .rice-type-select');
                    const firstQuantitySelect = document.querySelector('.rice-item-row .quantity-select');
                    if (firstRiceTypeSelect) firstRiceTypeSelect.value = '糙米';
                    if (firstQuantitySelect) firstQuantitySelect.value = '1';
                    calculateTotalPrice(); // 更新總金額顯示
                }
            } catch (err) {
                console.error('捕獲到錯誤:', err);
                showMessage(`提交訂單時發生未知錯誤: ${err.message}`, "error");
            } finally {
                // 無論成功或失敗，重新啟用按鈕
                submitOrderBtn.disabled = false;
                submitOrderBtn.textContent = '提交訂單';
                submitOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- 頁面載入完成後執行 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化第一個米品項目的數量選項
            document.querySelector('.rice-item-row .quantity-select').innerHTML = generateQuantityOptions();

            // 為第一個米品項目綁定事件監聽器
            document.querySelector('.rice-item-row .quantity-select').addEventListener('change', calculateTotalPrice);
            document.querySelector('.rice-item-row .rice-type-select').addEventListener('change', calculateTotalPrice);
            document.querySelector('.rice-item-row .remove-item-btn').addEventListener('click', (e) => {
                if (riceItemsContainer.querySelectorAll('.rice-item-row').length > 1) {
                    e.target.closest('.rice-item-row').remove();
                    calculateTotalPrice();
                } else {
                    showMessage("至少需要保留一個訂購項目。", "error");
                }
            });

            calculateTotalPrice(); // 初始計算一次總金額

            // 新增米品按鈕點擊事件
            addRiceItemBtn.addEventListener('click', addRiceItemRow);

            // 提交按鈕點擊事件
            submitOrderBtn.addEventListener('click', submitOrder);
        });
    </script>
</body>
</html>
